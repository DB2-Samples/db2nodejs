<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>{{userID}}</title>
    <link rel="stylesheet" type="text/css" href="build/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="build/bootstrap/css/bootstrap-grid.min.css">
    <link rel="stylesheet" type="text/css" href="build/bootstrap/css/bootstrap-reboot.min.css">
    <script src="/socket.io/socket.io.js"></script>
    <script src="build/jquery.min.js"></script>
    <script src="service/service.js"></script>
    <style>
        body{position: relative;overflow: hidden;}
        .main {
            height: calc(100% - 56px);
            width: 100%;
            overflow: hidden;
        }
        .blur{
            -webkit-filter: blur(5px); /* Chrome, Opera */
            -moz-filter: blur(5px);
            -ms-filter: blur(5px);
            filter: blur(5px);
        }
        .left-control, .main-screen{
            display: block;
            float: left;
            height: 100%;
            -webkit-transition: width .5s;
            -moz-transition: width .5s;
            -ms-transition: width .5s;
            -o-transition: width .5s;
            transition: width .5s;
            margin:0;
            padding: 0;
            overflow: hidden;
        }
        .main-screen{
            overflow: auto;
        }
        .credential, .client-control{
            height:70%;
            border-bottom: 1px solid #666;
            padding:10px 20px;
            overflow: auto;
        }
        .client-control{
            height:30%;
            border:none;
        }
        .credential h4, .client-control h4{
            margin-bottom: 20px;
        }
        #demo div{
            margin: 20px 10px;
        }
        button{
            margin:10px;
        }
        .form-group span{
            font-size: 12px;
            display: block;
            color:red;
            margin-bottom:-5px;
        }
        #progressBar{
            display: none;
            width: 100%;
            height: 20px;
            position: fixed;
            top:0;
            left:0;
            margin: 0;
            z-index: 100;
        }
        #progressBar div{
            width: 100%;
            height: 10px;
            position: absolute;
            top:0;
            left: 0;
        }
        #progressBar div span{
            position: absolute;
            display: inline-block;
            background: #007bff;
            height: 10px;
            width: 100%;
            animation:bgLoad 3s infinite;
            -webkit-animation:bgLoadw 3s infinite;
        }
        @keyframes bgLoad{
            0%{
                width: 0%;
            }
            100%{
                width:100%;
            }
        }
        @-webkit-keyframes bgLoadw{
            0%{
                width: 0%;
            }
            100%{
                width:100%;
            }
        }
        .pos-f-t{
            z-index: 10;
            position: relative;
        }
        .topWarn{
            z-index: 5;
            height:80px;
            position: absolute;
            width:100%;
            -webkit-transition: top .5s;
            -moz-transition: top .5s;
            -ms-transition: top .5s;
            -o-transition: top .5s;
            transition: top .5s;
        }
        #okBtn{
            margin-left: 100px;
        }
    </style>
</head>
<body>
    <div id="progressBar"><div><span></span></div></div>
    <div class="pos-f-t">
        <nav class="navbar navbar-dark bg-dark">
            <button onclick="toggle()" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarToggleExternalContent" aria-controls="navbarToggleExternalContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
        </nav>
    </div>
    <div id="popupDialog" style="top:-10px" class="alert alert-warning topWarn">
        <strong>Warning!</strong>
        <span>Best check yo self, you're not looking too good.</span>

        <button type="button" id="okBtn" class="btn btn-info" data-dismiss="alert">OK</button>
        <button type="button" id="cancelBtn" class="btn btn-dark" data-dismiss="alert">Cancel</button>
    </div>
    <div class="main">
        <span style="width: 30%;" class="left-control bg-light">
            <div class="credential">
                <h4>Db2 Credential</h4>
                   <div class="row form-group">
                        <div class="col-7">
                          <input onclick="checkValid(this,true)" onblur="checkValid(this)" id="hostname" value="{{hostname}}" name="hostname" type="text" class="form-control" placeholder="Host name">
                            <span></span>
                        </div>
                        <div class="col-5">
                          <input onclick="checkValid(this,true)" onblur="checkValid(this)" id="port" value="{{port}}" name="port" type="number" class="form-control" placeholder="Port">
                            <span></span>
                        </div>
                    </div>
                  <div class="form-group">
                    <input onclick="checkValid(this,true)" onblur="checkValid(this)" type="text" style="text-transform:uppercase;" class="form-control" value="{{db}}" id="dbname" name="dbname" aria-describedby="emailHelp" placeholder="DB name ">
                      <span></span>
                  </div>
                <div class="form-group">
                    <input onclick="checkValid(this,true)" onblur="checkValid(this)" type="text" class="form-control" value="{{username}}" id="dbuser" name="dbuser" aria-describedby="emailHelp" placeholder="DB2 User ">
                    <span></span>
                  </div>
                  <div class="form-group">
                    <input onclick="checkValid(this,true)" onblur="checkValid(this)" type="password" id="dbpassword" value="{{password}}" name="dbpassword" class="form-control" id="exampleInputPassword1" placeholder="Password">
                      <span></span>
                  </div>
                    <div>
                        <button onclick="test()" type="submit" class="btn btn-primary">Test connection</button>
                    </div>
                    <div>
                        <button onclick="confirmLoad()" class="btn btn-primary">Load data</button>
                        <button onclick="confirmClean()" class="btn btn-danger">Clear data</button>
                    </div>
            </div>
            <div class="client-control">
                <h4>Application Connection</h4>
                    <div class="form-group">
                        <input onclick="checkValid(this,true)" onblur="checkValid(this)" class="form-control" id="clientnumber" type="number" aria-describedby="emailHelp" placeholder="Enter web store number">
                        <span></span>
                    </div>
                 <button type="button" onclick="start()" class="btn btn-primary">START</button>
                  <button type="button" onclick="stop()" class="btn btn-danger">STOP</button>
            </div>
        </span>
        <span style="width: 70%;" id="demo" class="main-screen bg-secondary">

        </span>
    </div>
<script>
    var i = 1;
    var socket = io();
    var shops = {};
    var bgColor = ["alert-success", "alert-info", "alert-warning", "alert-danger"];
    window.service = new LoadData();

    document.getElementById('clientnumber').onkeydown = function(e){
        if(e.which===13){
            start();
        }
    }

    socket.on('connect', function () {

    });

    function buildRetailer(num){
        document.getElementById('demo').innerHTML = "";
        shops = {};
        for(var i=1;i<=parseInt(num);i++){
            var shop = '<div id="shop'+i+'" class="alert '+bgColor[i%4]+'">Building</div>';
            document.getElementById('demo').innerHTML += shop;
            shops['shop'+i] = [];
        }
    }

    function checkValid(node, sigh){
        if(!node.value){
            node.parentNode.querySelector('span').innerHTML = "Required field!";
        }
        else{
            node.parentNode.querySelector('span').innerHTML = "";
        }
        if(sigh)
            node.parentNode.querySelector('span').innerHTML = "";
    }

    function handleRetailer(num, user, verb){
        var key = "shop"+num;
        var shop = document.getElementById(key);
        if(shop) {
            if (user == "OPEN" && verb == "OPEN") {
                shop.innerHTML = "OPEN!!!";
            }
            else if (user == "CLOSE" && verb == "CLOSE") {
                shop.innerHTML = "CLOSED!!!";
            }
            else {
                var retailer = shops[key]
                var inn = "";var j = -1;
                for(var i = 0;i < retailer.length;i++){
                    var br = i==(retailer.length-1)?"":'<br/>';
                    if(retailer[i].name==user){
                        inn += user + ' ' + verb + br;
                        j = i;
                    }
                    else inn += retailer[i].name + ' ' + retailer[i].verb + br;
                }
                if(j==-1){
                    var br = retailer.length==0?"":'<br/>';
                    inn += br + user + ' ' + verb;
                    retailer.push({name:user,verb:verb});
                }
                shop.innerHTML = inn;
                if(verb=="signs out")
                    retailer.splice(j,1);
            }
        }
    }

    function start(){
        var params = getFormBody();
        if(!params){
            //alert("Please enter the db2 credential first!");
            return ;
        }
        var reg = /^[0-9]*[1-9][0-9]*$/;
        var num = document.getElementById("clientnumber").value;
        if(!num) {checkValid(document.getElementById("clientnumber"));return ;};
        if(!reg.test(num)){
            alert("Please enter a digit number");
            return ;
        }

        params.num = num;

        socket.emit('start', params);
        buildRetailer(num);
        socket.on('msg', function (clientNum, user, verb) {
            handleRetailer(clientNum, user, verb);
        });

        socket.on('sys', function (stat) {
            if(stat=='nocred'){
                alert("Db2 connection failed");
            }
            if(stat=='nodata'){
                alert("No data in certain db, please load data first");
            }
        });
    }
    function stop(){
        socket.emit('stop','haha');
    }
    function toggle() {
        var width = document.querySelector('.left-control').style.width;
        var width1 = '30%'; var width2 = '70%';
        if(parseInt(width)==30){
            width1 = '0%';
            width2 = '100%';
        }
        document.querySelector('.left-control').style.width = width1;
        document.querySelector('.main-screen').style.width = width2;
    }
    function getFormBody(){
        var hostname = document.getElementById("hostname").value.trim();
        if(!hostname) checkValid(document.getElementById("hostname"));
        var port = document.getElementById("port").value;
        if(!port) checkValid(document.getElementById("port"));
        var db = document.getElementById("dbname").value.toString().toUpperCase();
        if(!db) checkValid(document.getElementById("dbname"));
        var username = document.getElementById("dbuser").value.trim();
        if(!username) checkValid(document.getElementById("dbuser"));
        var password = document.getElementById("dbpassword").value;
        if(!password) checkValid(document.getElementById("dbpassword"));
        var userid = window.location.pathname.split("/")[1];
        if(hostname && port && db && username && password)
            return {hostname, port, db, username, password, userid};
        else {
            return null;
        }
    }
    function setFormBody(params) {
        var {hostname, port, db, username, password, userid} = params;
        document.getElementById("hostname").value = hostname;
        document.getElementById("port").value = port;
        document.getElementById("dbname").value = db;
        document.getElementById("dbuser").value = username;
        document.getElementById("dbpassword").value = password;
    }
    function load(){
        var params = getFormBody();
        if(params) {
            params.cmd = "load";
            service.load(params);
        }
    }
    function test(){
        var params = getFormBody();
        if(params) {
            params.cmd = "test";
            service.load(params);
        }
        //else alert("Please enter the db2 credential first!");
    }
    function clean(){
        var params = getFormBody();
        if(params) {
            params.cmd = "clear";
            service.load(params);
        }
        //else alert("Please enter the db2 credential first!");
    }
    function confirmLoad(){
        var params = {
            severity:"warn",
            title:"Notice!",
            body:"Are you sure to load the data, it may take several minutes?",
            okHandler:function(){
                service.showDialog({
                    severity:"info",
                    title:"PENDING.",
                    body:"Data loading may take several minutes, Please wait..."
                });
                load();
            },
            cancelHandler:service.hideDialog
        }
        service.showDialog(params);
    }
    function confirmClean(){
        var params = {
            severity:"error",
            title:"Warning!",
            body:"Are you sure to clean the data?",
            okHandler:clean,
            cancelHandler:service.hideDialog
        }
        service.showDialog(params);
    }
</script>
</body>
</html>
